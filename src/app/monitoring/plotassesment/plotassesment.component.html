<div class="col-12">
  <div class="card">

    <!-- toolbar -->
    <p-toolbar styleClass="p-mb-4">
      <ng-template pTemplate="left">
        <h4>Plot Assessments</h4>
      </ng-template>
      <ng-template pTemplate="right">
        <button pButton pRipple label="New Plot Assesment" icon="pi pi-plus" class="p-button-primary p-mr-2"
          (click)="initPlotAssesment()"></button>
      </ng-template>
    </p-toolbar>

    <!-- dialog -->
    <p-dialog header="Plot Assessment" [(visible)]="showDialog" [modal]="true"
      [breakpoints]="{'960px': '75vw', '640px': '100vw'}" [style]="{width: '75vw'}">
      <form [formGroup]="fbPlotAssesment" (ngSubmit)="onSubmit()">
        <p-tabView orientation="left">
          <p-tabPanel header="Plot Assesment" class="col-12">
            <div class="flex flex-column  justify-content-center">
              <div class="grid">
                <div class="col-12">
                  <p-fieldset legend="Season" [toggleable]="true" class="line-height-3 m-0"
                    [transitionOptions]="'500ms'">
                    <div class="p-fluid p-formgrid grid">
                      <div class="field col-12 md:col-4 lg:col-3 ">
                        <label>Season:</label>
                        <p-dropdown class="ml-2" placeholder="Select a season" optionLabel="name" [options]="seasons"
                          [(ngModel)]="currentSeason.seasonId" optionValue="seasonId" formControlName="seasonId"
                          (onChange)="initPlotReports($event.value)"  appendTo="body"
                          [ngClass]="{ 'is-invalid ng-dirty': FormControls['seasonId'].touched && FormControls['seasonId'].errors }">
                        </p-dropdown>
                        <span *ngIf="FormControls['seasonId'].touched && FormControls['seasonId'].invalid">
                          <div class="ng-invalid ng-touched p-error"
                            *ngIf="FormControls['seasonId'].errors?.['required']">
                            Select Season.</div>
                        </span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-3 ">
                        <label>Plot No:<sup class="p-error">*</sup></label>
                        <p-dropdown class="ml-2" placeholder="Select Plot" optionLabel="plotNumber"
                          [options]="plotReports" optionValue="plotId" formControlName="plotId"
                          (onChange)="getPlotinfo($event.value)" appendTo="body"
                          [ngClass]="{ 'is-invalid ng-dirty': FormControls['plotId'].touched && FormControls['plotId'].errors }">
                        </p-dropdown>
                        <span *ngIf="FormControls['plotId'].touched && FormControls['plotId'].invalid">
                          <div class="ng-invalid ng-touched p-error"
                            *ngIf="FormControls['plotId'].errors?.['required']">
                            Select Plot No.</div>
                        </span>
                      </div>
                    </div>
                  </p-fieldset>
                  <div class="grid">
                  <p-fieldset legend="Farmer Info" [toggleable]="true" class="col-6 mt-2" [transitionOptions]="'500ms'">
                    <div class="p-fluid p-formgrid grid">
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Farmer Code: </label><br/>
                        <span class="disabled_text">{{plotInfo.farmerCode}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Farmer Name: </label><br/>
                        <span class="disabled_text">{{plotInfo.farmerName}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Farmer Village: </label><br/>
                        <span class="disabled_text">{{plotInfo.farmerVillage}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Farmer Division: </label><br/>
                        <span class="disabled_text">{{plotInfo.farmerDivision}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold"> Farmer Circle: </label><br/>
                        <span class="disabled_text">{{plotInfo.farmerCircle}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Farmer Section: </label><br/>
                        <span class="disabled_text">{{plotInfo.farmerSection}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Offered No: </label><br/>
                        <span class="disabled_text">{{plotInfo.offerNo}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Crop Type: </label><br/>
                        <span class="disabled_text">{{plotInfo.cropType}}</span>
                      </div>
                      <div class="field col-12 md:col-6 lg:col-6">
                        <label class="font-bold">Crop: </label><br/>
                        <span class="disabled_text">{{plotInfo.Crop}}</span>
                      </div>
                    </div>
                  </p-fieldset>
                  <p-fieldset legend="Plot Info" [toggleable]="true" class="col-6 mt-2" [transitionOptions]="'500ms'">
                    <div class="p-fluid p-formgrid grid">
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Plot Division: </label><br/>
                        <span class="disabled_text">{{plotInfo.plotDivision}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Plot Circle: </label><br/>
                        <span class="disabled_text">{{plotInfo.plotCircle}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Plot Section: </label><br/>
                        <span class="disabled_text">{{plotInfo.plotSection}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Plot Village: </label><br/>
                        <span class="disabled_text">{{plotInfo.plotVillage}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Plant Type: </label><br/>
                        <span class="disabled_text">{{plotInfo.plantType}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Survey No: </label><br/>
                        <span class="disabled_text">{{plotInfo.surveyNo}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Reported Area: </label><br/>
                        <span class="disabled_text">{{plotInfo.reportedArea}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Planting Date: </label><br/>
                        <span class="disabled_text">{{plotInfo.plantingDate | date: mediumDate}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Variety: </label><br/>
                        <span class="disabled_text">{{plotInfo.variety}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Agreed Ton: </label><br/>
                        <span class="disabled_text">{{plotInfo.agreedTon}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Field Name: </label><br/>
                        <span class="disabled_text">{{plotInfo.fieldName}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">BIR Number: </label><br/>
                        <span class="disabled_text">{{plotInfo.birNumber}}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">BIR Date: </label><br/>
                        <span class="disabled_text">{{plotInfo.birDate | date: mediumDate }}</span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-4">
                        <label class="font-bold">Plot Type: </label><br/>
                        <span class="disabled_text">{{plotInfo.plotType}}</span>
                      </div>
                    </div>
                  </p-fieldset>
                  </div>
                  <p-fieldset legend="Assesment Info" [toggleable]="true" class="col-6 mt-2"
                    [transitionOptions]="'500ms'">
                    <div class="p-fluid p-formgrid grid">
                      <div class="field col-12 md:col-4 lg:col-3 ">
                        <label>Assessed Area:<sup class="p-error">*</sup></label>
                        <input pInputText type="name" formControlName="measuredArea" placeholder="Enter Assessed Area"
                          [ngClass]="{ 'is-invalid ng-dirty': FormControls['measuredArea'].touched && FormControls['measuredArea'].errors }">
                        <span *ngIf="FormControls['measuredArea'].touched && FormControls['measuredArea'].invalid">
                          <div class="ng-invalid ng-touched p-error"
                            *ngIf="FormControls['measuredArea'].errors?.['required']">
                            Select Assessed Area.</div>
                        </span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-3">
                        <label>Assessed Date:<sup class="p-error">*</sup></label>
                        <p-calendar [readonlyInput]="true" [showIcon]="true" mask="99/99/9999"
                          formControlName="assessedDate" placeholder="Please Select assessed Date" appendTo="body"
                          [ngClass]="{ 'is-invalid ng-dirty': FormControls['assessedDate'].touched && FormControls['assessedDate'].errors }">
                        </p-calendar>
                        <span *ngIf="FormControls['assessedDate'].touched && FormControls['assessedDate'].invalid">
                          <div class="ng-invalid ng-touched p-error"
                            *ngIf="FormControls['assessedDate'].errors?.['required']">
                            Select Assessed Date.</div>
                        </span>
                      </div>
                      <div class="field col-12 md:col-4 lg:col-3 ">
                        <label>Demo Plot Area:</label><br>
                        <p-inputSwitch formControlName="isaDemoPlot"></p-inputSwitch>
                      </div>
                    </div>
                  </p-fieldset>
                </div>
              </div>
            </div>
          </p-tabPanel>
          <p-tabPanel header="Weedicide" class="line-height-3 m-0">
            <div class="flex flex-column  justify-content-center">
              <div class="grid">
                <div class="col-12">
                  <div class="p-fluid p-formgrid grid">
                    <div class="field col-12 md:col-4 lg:col-3 ">
                      <label>Weed Status:</label>
                      <p-dropdown optionLabel="name" optionValue="lookupDetailId" [options]="weedstatus" appendTo="body"
                        formControlName="weedStatusId" [autoDisplayFirst]="false" placeholder="Select Weed Status"
                        [ngClass]="{ 'is-invalid ng-dirty': FormControls['weedStatusId'].touched && FormControls['weedStatusId'].errors }">
                      </p-dropdown>
                      <span *ngIf="FormControls['weedStatusId'].touched && FormControls['weedStatusId'].invalid">
                        <div class="ng-invalid ng-touched p-error"
                          *ngIf="FormControls['weedStatusId'].errors?.['required']">
                          Select Weed Status.</div>
                      </span>
                    </div>
                    <div class="field col-12 md:col-4 lg:col-3 ">
                      <label>Inter Croping:</label>
                      <p-dropdown optionLabel="name" [options]="cropstypes" optionValue="lookupDetailId" appendTo="body"
                        formControlName="interCropId" [autoDisplayFirst]="false" placeholder="Select Inter Croping"
                        [ngClass]="{ 'is-invalid ng-dirty': FormControls['interCropId'].touched && FormControls['interCropId'].errors }">
                      </p-dropdown>
                      <span *ngIf="FormControls['interCropId'].touched && FormControls['interCropId'].invalid">
                        <div class="ng-invalid ng-touched p-error"
                          *ngIf="FormControls['interCropId'].errors?.['required']">
                          Select Inter Croping.</div>
                      </span>
                    </div>
                    <div class="field col-12 md:col-6  lg:col-3 ">
                      <label>Micronutrient Deficiency:</label><br>
                      <p-inputSwitch formControlName="micronutrientdeficiency"></p-inputSwitch>
                    </div>
                    <div class="field col-12 md:col-6  lg:col-3 ">
                      <label>Trash Mulching:</label><br>
                      <p-inputSwitch formControlName="trashmulching"></p-inputSwitch>
                    </div>
                    <div class="field col-12 md:col-6  lg:col-3 ">
                      <label>Gap Filing Done:</label><br>
                      <p-inputSwitch formControlName="gapfillingdone"></p-inputSwitch>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <p-tabView orientation="left">
              <p-tabPanel header="Weedicide">
                <div class="grid col-12">
                  <div formArrayName='weedicides' class="checkboxList grid">
                    <ng-container *ngIf="this.fbPlotAssesment.controls['weedicides'] as formArray">
                      <div *ngFor="let item of getFormArrayControl('weedicides').controls; let i = index" class="col-3">
                        <div [formGroupName]="i" style="padding-left:unset" class="capitalize form-control">
                          <p-inputSwitch [(ngModel)]="item.value.checked!" [ngModelOptions]="{standalone: true}">
                          </p-inputSwitch>
                          <label for="ny" class="ml-2 vertical-align-top">{{item.value.name}}</label>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </p-tabPanel>

              <p-tabPanel header="Pests" class="col-12">
                <div class="col-12">
                  <div formArrayName='pests' class="checkboxList">
                    <p-table #dt2 dataKey="id" [value]="getFormArrayControl('pests').controls" [rows]="10"
                      [rowHover]="true" styleClass="p-datatable-gridlines p-datatable-striped p-datatable-sm"
                      [paginator]="false"  [autoLayout]="true" responsiveLayout="scroll"
                      [rowsPerPageOptions]="[10,25,50]" [tableStyle]="{ width: '100%'}">
                      <ng-template pTemplate="header">
                        <tr>
                          <th>Name</th>
                          <th>Identified Date</th>
                          <th>Control Date</th>
                          <th>Remarks</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-pestControl let-i="rowIndex">
                        <tr [formGroupName]="i">
                          <td>
                            <div class="font-bold">
                              {{pestControl.get('name').value}}
                            </div>
                          </td>
                          <td>
                            <p-calendar [readonlyInput]="true" [showIcon]="true" mask="99/99/9999" appendTo="body"
                              placeholder=" Please Select Identified Date" formControlName="identifiedDate">
                            </p-calendar>
                          </td>
                          <td>
                            <p-calendar [readonlyInput]="true" [showIcon]="true" mask="99/99/9999" appendTo="body"
                              placeholder=" Please Select Control Date" formControlName="controlDate">
                            </p-calendar>
                          </td>
                          <td>
                            <input pInputText formControlName="remarks">
                          </td>
                        </tr>

                      </ng-template>
                      <ng-template pTemplate="emptymessage">
                        <tr>
                          <td colspan="8">No customers found.</td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </div>
              </p-tabPanel>
            </p-tabView>
          </p-tabPanel>
          <p-tabPanel header="Fertilizer/Disease" class="line-height-3 m-0">
            <p-tabView orientation="left">
              <p-tabPanel header="Fertilizers " class="col-12">
                <div class="grid col-12">
                  <div formArrayName='fertilizers' class="checkboxList grid">
                    <ng-container *ngIf="this.fbPlotAssesment.controls['fertilizers'] as formArray">
                      <div *ngFor="let item of getFormArrayControl('fertilizers').controls; let i = index"
                        class="col-3">
                        <div [formGroupName]="i" style="padding-left:unset">
                          <p-inputSwitch [(ngModel)]="item.value.checked!" [ngModelOptions]="{standalone: true}">
                          </p-inputSwitch>
                          <label for="ny" class="ml-2 vertical-align-top">{{item.value.name}}</label>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </p-tabPanel>
              <p-tabPanel header="Diseases" class="col-12">
                <div class="col-12">
                  <div formArrayName='diseases' class="checkboxList">
                    <p-table #dt2 dataKey="id" [value]="getFormArrayControl('diseases').controls" [rows]="10"
                      [rowHover]="true" styleClass="p-datatable-gridlines p-datatable-striped p-datatable-sm"
                      [paginator]="false" [autoLayout]="true" responsiveLayout="scroll"
                      [rowsPerPageOptions]="[10,25,50]">
                     
                      <ng-template pTemplate="header">
                        <tr>
                          <th>Name</th>
                          <th>Identified Date</th>
                          <th>Control Date</th>
                          <th>Remarks</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-diseaseControl let-i="rowIndex">
                        <tr [formGroupName]="i">
                          <td>
                            <div class="font-bold">
                              {{diseaseControl.get('name').value}}
                            </div>
                          </td>
                          <td>
                            <p-calendar [readonlyInput]="true" [showIcon]="true" mask="99/99/9999" appendTo="body"
                              placeholder="Please Select Identified Date" formControlName="identifiedDate">
                            </p-calendar>
                          </td>
                          <td>
                            <p-calendar [readonlyInput]="true" [showIcon]="true" mask="99/99/9999" appendTo="body"
                              placeholder="Please Select Control Date" formControlName="controlDate">
                            </p-calendar>
                          </td>
                          <td>
                            <input pInputText formControlName="remarks">
                          </td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </div>
              </p-tabPanel>
            </p-tabView>
          </p-tabPanel>
        </p-tabView>
      </form>
      <ng-template pTemplate="footer">
        <div class="col-12">
          <div class="col-4" style="float:right">
            <button pButton pRipple type="submit" label="{{submitLabel}}" class="p-button-raised p-button-primary"
              (click)="onSubmit()"></button>
          </div>
        </div>
      </ng-template>
    </p-dialog>
    <!-- table -->
    <p-table #assessments dataKey="farmerCode" [value]="plotAssessments" [rows]="10" [rowHover]="true"
      styleClass="p-datatable-gridlines p-datatable-striped p-datatable-sm" [paginator]="true" [autoLayout]="true"
      responsiveLayout="scroll" [rowsPerPageOptions]="[10,25,50]" [tableStyle]="{ width: 'max-content'}">
      <ng-template pTemplate="caption">
        <div class="flex justify-content-between flex-column sm:flex-row">
          <button pButton label="Clear" class="p-button-outlined mb-2" icon="pi pi-filter-slash"
            (click)="clear(assessments)"></button>
          <div>
            <span class="p-input-icon-left mb-2">
              <i class="pi pi-search"></i>
              <input pInputText type="text" #filter (input)="onGlobalFilter(assessments, $event)"
                placeholder="Search Keyword" class="w-full">
            </span>
            <p-dropdown class="ml-2" placeholder="Select a season" optionLabel="name" [options]="seasons"
              [(ngModel)]="currentSeason.seasonId" (onChange)="initPlotAssesments($event.value)" optionValue="seasonId">
            </p-dropdown>
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th></th>
          <th *ngFor="let col of farmerHeader" [pSortableColumn]="col.header">
            {{col?.label}} <p-sortIcon field="code">
            </p-sortIcon>
            <p-columnFilter type="text" [field]="col.header" display="menu"></p-columnFilter>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-farmer let-expanded="expanded">
        <tr>
          <td>
            <button type="button" pButton pRipple [pRowToggler]="farmer"
              class="p-button-text p-button-rounded p-button-plain"
              [icon]="expanded ? 'pi pi-chevron-down':  'pi pi-chevron-right'"></button>
          </td>

          <td *ngFor="let col of farmerHeader">
            <span>{{farmer[col.field]}}</span>
            <span *ngIf="col?.field == 'assessedDate' ||col?.field == 'assessedDate'">
              {{farmer[col.field] | date: 'dd-MM-yyyy'}}
            </span>

          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion" let-farmer>
        <tr>
          <td colspan="5">
            <div class="p-3">
              <p-table [value]="farmer.ObjMeasuredPlots" [columns]="plotHeader" dataKey="plotId">
                <ng-template pTemplate="header">
        <tr>
          <th></th>
          <th *ngFor="let col of plotHeader" [pSortableColumn]="col.header">
            {{col?.label}} <p-sortIcon field="code">
            </p-sortIcon>
            <p-columnFilter type="text" [field]="col.header" display="menu"></p-columnFilter>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-plotAssessment>
        <tr>
          <td><button pButton pRipple icon="pi pi-pencil"
              class="p-element p-ripple p-button-text p-button p-component"></button>
          </td>
          <td *ngFor="let col of plotHeader">

            <span *ngIf="col?.field != 'offerDate' && col?.field != 'plantingDate'">{{plotAssessment[col.field]}}</span>
            <span *ngIf="col?.field == 'offerDate' || col?.field == 'plantingDate'">
              {{plotAssessment[col.field] | date: 'dd-MM-yyyy'}}
            </span>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6">There are no plots for this farmer yet.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  </td>
  </tr>

  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="20" class="md:text-center">No Plot Assesment Found.</td>
    </tr>
  </ng-template>
  <ng-template pTemplate="loadingbody">
    <tr>
      <td colspan="20" class="md:text-center">Loading Plot Assesment Data. Please wait.</td>
    </tr>
  </ng-template>
  </p-table>
</div>
</div>
